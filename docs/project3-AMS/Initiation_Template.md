## 立项模板 --： AMS(Alarm Management System警报管理系统)

## 1.  问题描述及原因 ：

- 现象：车间设备异常警报长时间（多频次数分钟）无人介入处理；警报对车间环境造成异常噪音影响员工高效工作；自动化的工艺时代产品UPH改善是巨大的影响原因；

- 原因：： A. 测试软件问题； B.电脑设置问题； C. DUT工装夹具问题；E:技术品质人员介入不足；F：员工技能不足；E：物料异常；
## 2.  需求描述 ：

 - 将每一台电脑的每一次死机重启、非法使用U盘类移动存储、无互联网权限的非法开启互联网使用的日志做数据统计管理，输出统计报表，超过阀值则自动产生问题条，做专项问题启动管理

## 3.  数据来源 ：

- 电脑配置，位置等信息来源 K3实际库的基础信息源

- 故障重启、非法使用U盘或非授权的互联网登陆信息来源： ***windows 客户端：PC Monitor Client.exe，启动后到上次到192.168.10.130 中的 pcmonitor. 数据库中的pcmo_datas 和 gateway_info（白名单权限表）

## 4.  数据库说明：

- 基于K3资产及主要行为信息库：  pcmo_datas（主要有IP、MAC、CPU型号信息、责任人、位置、更新时间等关键字段）

- 白名单库:  gateway_info（责任人、IP、MAC、网络权限、更新时间字段）

## 5.  逻辑功能要求 ：
- 5.1、核心功能：实现集中对连网电脑终端的U盘移动存储介质、网络连接状态的在线监测，并在前台醒目红色告警显示违规记录；并在后期有序实现将醒目报警呈现于主页的“消息通知”栏；

- 5.2、衔接逻辑：客户端：PC Monitor Client.exe，定时监测（实时监测的数据以60S为周期返回服务端并记录于中心数据库）-->后端服务处理所有记录并去重以重启次数累计方式呈现于前台浏览-->其他相关信息同步对应唯一的资产编码进行对应呈现-->异常告警数据除了在前端醒目红色告警提示外，另外运算数据库生成条件触发逻辑与其他系统（如DOC\OA等）实现管理追踪闭环链接；
##  
---------------------------------------
## 记录日期
---------------------------------------
   2025-10-20 19：54

---------------------------------------
   ## 记录人
  FullyYHC
---------------------------------------

## 数据库表结构
- devices表 ：包含device_id（自增主键）、dtu_sn（设备唯一标识符）、device_name等字段
- alarms表 ：包含id（主键）、device_id（外键）、state、start、end、duration、updated等字段
## 映射关系实现机制
## 1. 1.同步流程 ：   
   - 服务每60秒执行一次 sync_all_data 方法
   - 首先通过 get_device_list 获取最新设备列表
   - 使用 update_devices_table 更新devices表，采用REPLACE INTO语句，确保dtu_sn的唯一性
   - 然后通过 get_today_device_lamp_data 获取当天设备灯数据（报警记录）
   - 最后调用 update_alarms_table 更新警报表
## 2. 2.device_id映射过程 ：   
   - 在 update_alarms_table 方法中，首先执行SQL查询 SELECT dtu_sn, device_id FROM devices 获取完整的设备映射
   - 然后构建字典 device_mapping = {row[0]: row[1] for row in cursor.fetchall()}
   - 遍历IOT系统返回的数据时，使用数据中的dtuSn查找对应的device_id
   - 确保每条报警记录都关联到正确的设备
## 3. 3.数据一致性保障 ：   
   - 每次同步都会先更新devices表，确保设备信息最新
   - 只处理当天的数据（通过日期过滤），避免历史数据干扰
   - 当找不到对应设备时，会记录警告日志并跳过该条记录
---------------------------------------
## 记录日期
---------------------------------------
   2025-10-21 10：41
---------------------------------------
   ## 记录人
  FullyYHC
---------------------------------------
