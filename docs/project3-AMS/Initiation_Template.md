## 立项模板 --： AMS(Alarm Management System警报管理系统)

## 1.  问题描述及原因 ：

- 现象：车间设备异常警报长时间（多频次数分钟）无人介入处理；警报对车间环境造成异常噪音影响员工高效工作；自动化的工艺时代产品UPH改善是巨大的影响原因；

- 原因：： A. 测试软件问题； B.电脑设置问题； C. DUT工装夹具问题；E:技术品质人员介入不足；F：员工技能不足；E：物料异常；
## 2.  需求描述 ：

 - 实时记录第台设备的报警类别、报警次数、报警时长，并实现在当天和指定历史时期的TOP排名，以供责任单位组织专项改善，为品质与产能进行保障；

## 3.  数据来源 ：

- 警报配置，位置等信息来源 警灯实际库的基础信息源

- 数据通过数据接口获取到CDT Database，并实现由JAVA脚本实现读取；

## 4.  数据库说明：
- ##2、前端页面主要实现的显示标准字段以及前后字段对应关系有：
  
  警灯编号               警灯位置                  报警时长             报警次数               更新时间                   //前端名字
  dut_id                 device_id                 duration        device_id出现次数          updated                    //后端字段

### 记录日期
2025-10-20 19：54

### 记录人
FullyYHC

## 5.  逻辑功能要求 ：
- 2.1：警灯位置/ device_id（需要映射devices表中device_name用来显示中文；其他字段在alarms表中获取对应数据；
- 2.2：报警次数/ 需要分别统计device_id在查询时间范围的出现次数（需要针对yellow和red实现分开统计），具体实现yellow和red可以在页头标准设定  yellow和red以及All的圆色控键对应 颜色报警数据的对应显示 ; 
- 3、标题菜单要有按警灯位置、警灯编号的模糊查找功能；
- 4、具体返回主页面按钮 和导出CSV功能按钮；要有时间起止选择框功能，默认时间为前一天的00:00:00到今天日期的23:59:59，全部使用标准北京时间格式设定与查询；
- 5、a、针对 报警时长 可以实现双击点开查询详情页对应alarms表中的具体 发生 `type` 、`start`、`end`、duration、updated信息；b、而针对报警次数要有去重功能，只显示对应alarms表中在设定查询时间范围内的具体 条目数的合计，同样要有双击可以查看详情页功能：
并对应可以查看： `start`、`end`、duration、updated信息；c、因为报警次数有去重机制，所以报警时长 在记录行首页只能显示当前   device_id 当前查询时间范围内报警时长最长的一条记录；
- 6、所有前端字段可以实现单击升降排序功能；
- 7、整体页面科技感风格可以与http://localhost/pcmonitor页面风格保持类似；
---------------------------------------
## 记录日期
---------------------------------------
   2025-10-20 19：54

---------------------------------------
   ## 记录人
  FullyYHC
---------------------------------------

## 数据库表结构
- devices表 ：包含device_id（自增主键）、dtu_sn（设备唯一标识符）、device_name等字段
- alarms表 ：包含id（主键）、device_id（外键）、state、start、end、duration、updated等字段
## 映射关系实现机制
## 1. 1.同步流程 ：   
   - 服务每60秒执行一次 sync_all_data 方法
   - 首先通过 get_device_list 获取最新设备列表
   - 使用 update_devices_table 更新devices表，采用REPLACE INTO语句，确保dtu_sn的唯一性
   - 然后通过 get_today_device_lamp_data 获取当天设备灯数据（报警记录）
   - 最后调用 update_alarms_table 更新警报表
## 2. 2.device_id映射过程 ：   
   - 在 update_alarms_table 方法中，首先执行SQL查询 SELECT dtu_sn, device_id FROM devices 获取完整的设备映射
   - 然后构建字典 device_mapping = {row[0]: row[1] for row in cursor.fetchall()}
   - 遍历IOT系统返回的数据时，使用数据中的dtuSn查找对应的device_id
   - 确保每条报警记录都关联到正确的设备
## 3. 3.数据一致性保障 ：   
   - 每次同步都会先更新devices表，确保设备信息最新
   - 只处理当天的数据（通过日期过滤），避免历史数据干扰
   - 当找不到对应设备时，会记录警告日志并跳过该条记录
---------------------------------------
## 记录日期
---------------------------------------
   2025-10-21 10：41
---------------------------------------
   ## 记录人
  FullyYHC
---------------------------------------
